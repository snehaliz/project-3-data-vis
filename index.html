<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Costco Warehouse Growth Visualization</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Costco Warehouse Growth</h1>
    <div id="visualization"></div>
        <!--link to write up-->
    <p><a href="https://snehaliz.github.io/project-3-data-vis/writeup.md" target="_blank">View Project Write-Up:</a></p>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson@3.0.2"></script>

    <script>
        d3.tsv("walmart.tsv").then(function(data) {
            console.log("Raw data:", data); 

            if (!data || data.length === 0) {
                console.error("No data available or the TSV file is empty.");
                return;
            }

            const parseDate = d3.utcParse("%m/%d/%Y");

            data = data.slice(1);  // since walmart.tsv's first row is a HEADER: "0, 1, date" we skip reading first row 

            // parse data, convert date to Date object, sanity check valid longitude & latitude
            data.forEach(d => {
                d.lon = +d["0"];  // 1st col = longitude
                d.lat = +d["1"];  // 2nd col = latitude
                d.date = parseDate(d["date"]);  
                console.log(`Parsed: lon=${d.lon}, lat=${d.lat}, date=${d.date}`);
            });

            const validData = data.filter(d => !isNaN(d.lon) && !isNaN(d.lat));
            console.log("Valid data:", validData);  

            if (validData.length === 0) {
                console.error("No valid data to plot.");
                return;
            }

            const projection = d3.geoAlbersUsa().scale(1280).translate([480, 300]);

            function renderChart(validData) {
                const svg = d3.create("svg")
                    .attr("viewBox", [0, 0, 960, 600]);

                d3.json("https://cdn.jsdelivr.net/npm/us-atlas@1/us/10m.json").then(function(us) {
                    console.log("US map data loaded", us);

                    console.log("US objects:", us.objects);

                    if (!us.objects.lower48) {
                        us.objects.lower48 = {
                            type: "GeometryCollection",
                            geometries: us.objects.states.geometries.filter(d => d.id !== "02" && d.id !== "15")
                        };
                    }

                    svg.append("path")
                        .datum(topojson.merge(us, us.objects.lower48.geometries))
                        .attr("fill", "#ddd")
                        .attr("d", d3.geoPath());

                    svg.append("path")
                        .datum(topojson.mesh(us, us.objects.lower48, (a, b) => a !== b))
                        .attr("fill", "none")
                        .attr("stroke", "white")
                        .attr("stroke-linejoin", "round")
                        .attr("d", d3.geoPath());

                    const g = svg.append("g")
                        .attr("fill", "none")
                        .attr("stroke", "black");

                    const dot = g.selectAll("circle")
                        .data(validData)
                        .join("circle")
                        .attr("transform", d => {
                            const [x, y] = projection([d.lon, d.lat]); 
                            if (x !== undefined && y !== undefined) {  
                                return `translate(${x},${y})`;
                            } else {
                                console.error("Invalid coordinates:", d);
                                return null;  
                            }
                        })
                        .attr("r", 3);

                    document.getElementById("visualization").appendChild(svg.node());
                }).catch(function(error) {
                    console.error("Error loading the map data:", error);
                });
            }

            renderChart(validData);

        }).catch(function(error) {
            console.error("Error loading the TSV file:", error);
        });
    </script>
</body>
</html>
